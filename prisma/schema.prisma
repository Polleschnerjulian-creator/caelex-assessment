generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth Required Tables

model User {
  id                     String                  @id @default(cuid())
  name                   String?
  email                  String?                 @unique
  emailVerified          DateTime?
  image                  String?
  password               String?                 // hashed password, null for OAuth-only users
  organization           String?                 // Legacy: organization name as string
  operatorType           String?                 // from assessment: SCO, LO, TCO, etc.
  establishmentCountry   String?                 // ISO country code
  isThirdCountry         Boolean                 @default(false)
  role                   String                  @default("user") // user, admin, auditor
  isActive               Boolean                 @default(true)
  theme                  String                  @default("system") // "light" | "dark" | "system"
  language               String                  @default("en") // en, de, fr, es
  accounts               Account[]
  sessions               Session[]
  articleStatuses        ArticleStatus[]
  checklistStatuses      ChecklistStatus[]
  authorizationWorkflows AuthorizationWorkflow[]
  auditLogs              AuditLog[]
  debrisAssessments      DebrisAssessment[]
  cybersecurityAssessments CybersecurityAssessment[]
  insuranceAssessments   InsuranceAssessment[]
  environmentalAssessments EnvironmentalAssessment[]
  supervisionConfig      SupervisionConfig?
  deadlines              Deadline[]
  missionPhases          MissionPhase[]
  documents              Document[]
  documentTemplates      DocumentTemplate[]
  generatedReports       SupervisionReport[]     @relation("GeneratedReports")
  scheduledReports       ScheduledReport[]
  reportArchives         ReportArchive[]
  ncaSubmissions         NCASubmission[]
  organizationMemberships OrganizationMember[]   // Multi-tenancy: user's org memberships
  notifications          Notification[]
  notificationPreference NotificationPreference?
  userSessions           UserSession[]
  securityAuditLogs      SecurityAuditLog[]
  apiKeys                ApiKey[]
  comments               Comment[]               // Collaboration: user's comments
  activities             Activity[]              // Collaboration: user's activities
  nis2Assessments        NIS2Assessment[]        // NIS2 Directive assessments
  copuosAssessments      CopuosAssessment[]      // COPUOS/IADC/ISO assessments
  ukSpaceAssessments     UkSpaceAssessment[]     // UK Space Industry Act assessments
  usRegulatoryAssessments UsRegulatoryAssessment[] // US Space Regulatory assessments
  exportControlAssessments ExportControlAssessment[] // ITAR/EAR Export Control assessments
  spectrumAssessments    SpectrumAssessment[]    // Spectrum/ITU Compliance assessments
  astraConversations     AstraConversation[]     // ASTRA AI conversations

  // Unified Assessment
  unifiedAssessmentResult      String?   @db.Text // JSON string of full assessment result
  unifiedAssessmentCompletedAt DateTime?

  // Security: MFA & Passkeys
  mfaConfig              MfaConfig?
  webAuthnCredentials    WebAuthnCredential[]
  loginEvents            LoginEvent[]

  // Security: Account Lockout
  failedLoginAttempts    Int                     @default(0)
  lockedUntil            DateTime?
  unlockToken            String?                 @unique
  unlockTokenExpires     DateTime?

  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Compliance Tracker ───

model ArticleStatus {
  id        String   @id @default(cuid())
  userId    String
  articleId String   // matches Article.id from data (e.g., "art-6")
  status    String   @default("not_started") // not_started | in_progress | under_review | compliant | not_applicable
  notes     String?  @db.Text
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@index([userId])
}

model ChecklistStatus {
  id          String   @id @default(cuid())
  userId      String
  checklistId String   // matches ChecklistItem.id from data
  completed   Boolean  @default(false)
  notes       String?  @db.Text
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, checklistId])
  @@index([userId])
}

// ─── Authorization Workflow ───

model AuthorizationWorkflow {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // NCA Information
  primaryNCA       String   // NCA ID (e.g., "de" for Germany)
  primaryNCAName   String   // Full name for display
  secondaryNCAs    String?  // JSON array of secondary NCA IDs
  pathway          String   // 'national_authorization' | 'euspa_registration' | 'commission_decision'

  // Operator context
  operatorType     String?  // SCO, LO, LSO, etc.
  launchCountry    String?  // For launch operators

  // Status
  status           String   @default("not_started") // not_started | in_progress | submitted | under_review | approved | rejected

  // Timeline
  targetSubmission DateTime?
  startedAt        DateTime?
  submittedAt      DateTime?
  approvedAt       DateTime?
  rejectedAt       DateTime?
  rejectionReason  String?  @db.Text

  // Relations
  documents        AuthorizationDocument[]

  // Notes
  notes            String?  @db.Text

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([userId, status, targetSubmission])
}

model AuthorizationDocument {
  id           String                @id @default(cuid())
  workflowId   String
  workflow     AuthorizationWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  // Document info
  documentType String   // 'mission_description', 'debris_plan', 'insurance_proof', etc.
  name         String   // Display name
  description  String?  @db.Text
  articleRef   String?  // e.g., "Art. 7(2)(a)"
  required     Boolean  @default(true)

  // Status
  status       String   @default("not_started") // not_started | in_progress | ready | submitted | approved | rejected

  // Timeline
  dueDate      DateTime?
  completedAt  DateTime?
  submittedAt  DateTime?

  // File reference (for future file uploads)
  fileUrl      String?
  fileName     String?
  fileSize     Int?

  // Notes
  notes        String?  @db.Text

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([workflowId])
  @@index([status])
}

// ─── Audit Trail ───

model AuditLog {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // What happened
  action        String   // 'article_status_changed', 'document_uploaded', 'checklist_completed', etc.
  entityType    String   // 'article', 'checklist', 'document', 'authorization', 'workflow'
  entityId      String   // ID of the affected object

  // Change details
  previousValue String?  @db.Text // JSON string of previous state
  newValue      String?  @db.Text // JSON string of new state
  description   String?  // Human-readable description of the change

  // Context
  ipAddress     String?
  userAgent     String?

  // Hash chain integrity
  entryHash     String?   // SHA-256 hash of this entry
  previousHash  String?   // Hash of the previous entry (chain link)

  // Timestamp (critical for audits)
  timestamp     DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([action])
  @@index([entryHash])
}

// ─── Debris Assessment ───

model DebrisAssessment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Mission Profile
  missionName          String?
  orbitType            String   // LEO, MEO, GEO, HEO, cislunar
  altitudeKm           Int?
  satelliteCount       Int      @default(1)
  constellationTier    String   // single, small, medium, large, mega
  hasManeuverability   String   // full, limited, none
  hasPropulsion        Boolean  @default(false)
  hasPassivationCap    Boolean  @default(false)
  plannedDurationYears Int      @default(5)
  launchDate           DateTime?
  deorbitStrategy      String   // active_deorbit, passive_decay, graveyard_orbit, adr_contracted
  deorbitTimelineYears Int?

  // CA Service
  caServiceProvider    String?

  // Status
  complianceScore      Int?     // 0-100
  planGenerated        Boolean  @default(false)
  planGeneratedAt      DateTime?

  // Relations
  requirements         DebrisRequirementStatus[]

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
}

model DebrisRequirementStatus {
  id            String           @id @default(cuid())
  assessmentId  String
  assessment    DebrisAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  requirementId String   // matches DebrisRequirement.id from data
  status        String   @default("not_assessed") // compliant, non_compliant, not_assessed, not_applicable
  notes         String?  @db.Text
  evidenceNotes String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([assessmentId, requirementId])
  @@index([assessmentId])
}

// ─── Cybersecurity Assessment ───

model CybersecurityAssessment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Organization Profile
  assessmentName       String?
  organizationSize     String   // micro, small, medium, large
  employeeCount        Int?
  annualRevenue        Float?   // EUR

  // Space Operations
  spaceSegmentComplexity String  // single_satellite, small_constellation, large_constellation, ground_only
  satelliteCount       Int?
  hasGroundSegment     Boolean  @default(true)
  groundStationCount   Int?

  // Data & Sensitivity
  dataSensitivityLevel String   // public, internal, confidential, restricted
  processesPersonalData Boolean @default(false)
  handlesGovData       Boolean  @default(false)

  // Existing Security
  existingCertifications String? // JSON array: ['iso27001', 'soc2']
  hasSecurityTeam      Boolean  @default(false)
  securityTeamSize     Int?
  hasIncidentResponsePlan Boolean @default(false)
  hasBCP               Boolean  @default(false)

  // Supply Chain
  criticalSupplierCount Int?
  supplierSecurityAssessed Boolean @default(false)

  // Calculated
  isSimplifiedRegime   Boolean  @default(false)
  maturityScore        Int?     // 0-100
  frameworkGenerated   Boolean  @default(false)
  frameworkGeneratedAt DateTime?

  // Relations
  requirements         CybersecurityRequirementStatus[]

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
}

model CybersecurityRequirementStatus {
  id            String                   @id @default(cuid())
  assessmentId  String
  assessment    CybersecurityAssessment  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  requirementId String   // matches CybersecurityRequirement.id
  status        String   @default("not_assessed") // compliant, partial, non_compliant, not_assessed, not_applicable
  notes         String?  @db.Text
  evidenceNotes String?  @db.Text
  targetDate    DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([assessmentId, requirementId])
  @@index([assessmentId])
}

// ─── NIS2 Directive Assessment ───

model NIS2Assessment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Assessment Info
  assessmentName       String?

  // Entity Classification (NIS2 Art. 3-4)
  entityClassification String?  // "essential" | "important" | "out_of_scope"
  classificationReason String?  @db.Text

  // Sector Info (NIS2 Annex I/II)
  sector               String?  // "space" | "transport" | "digital_infrastructure" | etc.
  subSector            String?  // "ground_infrastructure" | "satellite_communications" | "spacecraft_manufacturing"

  // Organization Profile
  organizationSize     String?  // micro, small, medium, large
  employeeCount        Int?
  annualRevenue        Float?   // EUR
  memberStateCount     Int      @default(1) // Number of EU member states with operations

  // Space-Specific Context
  operatesGroundInfra  Boolean  @default(false)
  operatesSatComms     Boolean  @default(false)
  manufacturesSpacecraft Boolean @default(false)
  providesLaunchServices Boolean @default(false)
  providesEOData       Boolean  @default(false)

  // Existing Compliance
  existingCertifications String? // JSON array: ['iso27001', 'soc2', 'tisax']
  hasISO27001          Boolean  @default(false)
  hasExistingCSIRT     Boolean  @default(false)
  hasRiskManagement    Boolean  @default(false)

  // NIS2 Compliance Specifics
  hasDesignatedRepresentative Boolean @default(false) // Art. 26-27
  hasRegisteredWithAuthority  Boolean @default(false) // Art. 3(4)

  // Supervisory Authority
  supervisoryAuthority String?  // Member state NCA responsible for NIS2

  // Calculated Results
  complianceScore      Int?     // 0-100
  maturityScore        Int?     // 0-100
  riskLevel            String?  // low, medium, high, critical

  // Overlap with EU Space Act
  euSpaceActOverlapCount Int?   // Number of overlapping requirements

  // Report
  reportGenerated      Boolean  @default(false)
  reportGeneratedAt    DateTime?

  // Relations
  requirements         NIS2RequirementStatus[]

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@index([entityClassification])
}

model NIS2RequirementStatus {
  id            String          @id @default(cuid())
  assessmentId  String
  assessment    NIS2Assessment  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  requirementId String   // matches NIS2Requirement.id from data file
  status        String   @default("not_assessed") // compliant, partial, non_compliant, not_assessed, not_applicable
  notes         String?  @db.Text
  evidenceNotes String?  @db.Text
  targetDate    DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([assessmentId, requirementId])
  @@index([assessmentId])
}

// ─── Insurance Assessment ───

model InsuranceAssessment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Assessment Info
  assessmentName       String?

  // Risk Profile
  primaryJurisdiction  String   // FR, DE, IT, etc.
  operatorType         String   // spacecraft, launch, launch_site
  companySize          String   // micro, small, medium, large

  // Operations Profile
  orbitRegime          String   // LEO, MEO, GEO, HEO, cislunar, deep_space
  satelliteCount       Int      @default(1)
  satelliteValueEur    Float?
  totalMissionValueEur Float?
  isConstellationOperator Boolean @default(false)
  hasManeuverability   Boolean  @default(false)
  missionDurationYears Int      @default(5)
  hasFlightHeritage    Boolean  @default(false)
  launchVehicle        String?  // Name of launch vehicle
  launchProvider       String?  // Name of launch provider
  launchDate           DateTime?

  // Risk Factors
  hasADR               Boolean  @default(false) // Active debris removal
  hasPropulsion        Boolean  @default(false)
  hasHazardousMaterials Boolean @default(false) // Nuclear, etc.
  crossBorderOps       Boolean  @default(false)

  // Financial
  annualRevenueEur     Float?
  turnoversShareSpace  Float?   // Percentage of revenue from space ops

  // Calculated Results
  calculatedTPL        Float?   // Third Party Liability requirement in EUR
  riskLevel            String?  // low, medium, high, very_high
  complianceScore      Int?     // 0-100
  reportGenerated      Boolean  @default(false)
  reportGeneratedAt    DateTime?

  // Relations
  policies             InsurancePolicy[]

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
}

model InsurancePolicy {
  id            String              @id @default(cuid())
  assessmentId  String
  assessment    InsuranceAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  // Policy Type
  insuranceType String   // pre_launch, launch, in_orbit, third_party_liability, contingent_liability, loss_of_revenue, launch_plus_life

  // Status tracking
  status        String   @default("not_started") // not_started, quote_requested, quote_received, under_review, bound, active, expiring_soon, expired, not_required
  isRequired    Boolean  @default(true)

  // Policy details
  policyNumber  String?
  insurer       String?
  broker        String?
  coverageAmount Float?  // In EUR
  premium       Float?   // Annual premium in EUR
  deductible    Float?

  // Timeline
  effectiveDate DateTime?
  expirationDate DateTime?
  renewalDate   DateTime?

  // Documents
  documentUrl   String?
  documentName  String?

  // Notes
  notes         String?  @db.Text
  quoteNotes    String?  @db.Text

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([assessmentId, insuranceType])
  @@index([assessmentId])
  @@index([status])
}

// ─── Environmental Assessment ───

model EnvironmentalAssessment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Assessment Info
  assessmentName       String?
  status               String   @default("draft") // draft, data_collection, calculation, review, submitted, approved

  // Mission Profile
  missionName          String?
  operatorType         String   // spacecraft, launch, launch_site
  missionType          String   // commercial, research, government, educational

  // Spacecraft Details
  spacecraftMassKg     Float
  spacecraftCount      Int      @default(1)
  orbitType            String   // LEO, MEO, GEO, HEO, cislunar, deep_space
  altitudeKm           Int?
  missionDurationYears Int      @default(5)

  // Launch
  launchVehicle        String   // ariane_6, vega_c, falcon_9, etc.
  launchSharePercent   Float    @default(100)
  launchSiteCountry    String?

  // Propulsion
  spacecraftPropellant String?  // hydrazine, green_propellant, xenon, etc.
  propellantMassKg     Float?

  // Operations
  groundStationCount   Int      @default(1)
  dailyContactHours    Float    @default(2)

  // End of Life
  deorbitStrategy      String   // controlled_deorbit, passive_decay, graveyard_orbit, retrieval

  // Simplified Regime Flags
  isSmallEnterprise    Boolean  @default(false)
  isResearchEducation  Boolean  @default(false)

  // Calculated Results
  totalGWP             Float?   // Total kg CO2eq
  totalODP             Float?   // Total kg CFC-11 eq
  carbonIntensity      Float?   // kg CO2eq per kg payload
  efdGrade             String?  // A, B, C, D, E
  complianceScore      Int?     // 0-100
  isSimplifiedAssessment Boolean @default(false)

  // Report
  reportGenerated      Boolean  @default(false)
  reportGeneratedAt    DateTime?

  // Relations
  impactResults        EnvironmentalImpactResult[]
  supplierRequests     SupplierDataRequest[]

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model EnvironmentalImpactResult {
  id            String                   @id @default(cuid())
  assessmentId  String
  assessment    EnvironmentalAssessment  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  // Lifecycle Phase
  phase         String   // raw_material_extraction, manufacturing, transport_to_launch, launch, operations, end_of_life

  // Impact Values
  gwpKgCO2eq    Float    // Climate change impact
  odpKgCFC11eq  Float    // Ozone depletion impact
  percentOfTotal Float   // Percentage contribution to total GWP

  // Additional impact categories (optional - for full LCA)
  acidificationMolHEq   Float?
  eutrophicationFwKgPEq Float?
  waterUseM3            Float?
  particulatesMatter    Float?
  resourceUseMinerals   Float?
  resourceUseFossils    Float?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([assessmentId, phase])
  @@index([assessmentId])
}

model SupplierDataRequest {
  id            String                   @id @default(cuid())
  assessmentId  String
  assessment    EnvironmentalAssessment  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  // Supplier Info
  supplierName  String
  supplierEmail String?
  componentType String   // Spacecraft Structure, Solar Arrays, Electronics, Propulsion, etc.

  // Request Details
  dataRequired  String   @db.Text // JSON array of required data points
  notes         String?  @db.Text

  // Status
  status        String   @default("pending") // pending, sent, received, overdue, not_applicable
  sentAt        DateTime?
  receivedAt    DateTime?
  deadline      DateTime?

  // Response Data
  responseData  String?  @db.Text // JSON object with supplier response

  // Relations
  portalTokens  SupplierPortalToken[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([assessmentId])
  @@index([status])
}

// ─── Supplier Portal Token ───
// Token-based access for suppliers to submit LCA data without authentication

model SupplierPortalToken {
  id           String              @id @default(cuid())
  token        String              @unique // Secure random token
  requestId    String
  request      SupplierDataRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  // Token Lifecycle
  expiresAt    DateTime
  usedAt       DateTime?           // When the token was first used
  completedAt  DateTime?           // When form was submitted

  // Access Tracking
  ipAddress    String?
  userAgent    String?
  accessCount  Int                 @default(0)
  lastAccessAt DateTime?

  // Security
  isRevoked    Boolean             @default(false)
  revokedAt    DateTime?
  revokedBy    String?
  revokeReason String?

  createdAt    DateTime            @default(now())

  @@index([token])
  @@index([requestId])
  @@index([expiresAt])
}

// ─── COPUOS/IADC/ISO Assessment ───

model CopuosAssessment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Assessment Info
  assessmentName       String?
  status               String   @default("draft") // draft, in_progress, completed, archived

  // Mission Profile
  missionName          String?
  orbitRegime          String   // LEO, MEO, GEO, HEO, GTO, cislunar, deep_space
  altitudeKm           Int?
  inclinationDeg       Float?
  missionType          String   // commercial, scientific, governmental, educational, military
  satelliteCategory    String   // cubesat, smallsat, medium, large, mega
  satelliteMassKg      Float
  hasManeuverability   Boolean  @default(false)
  hasPropulsion        Boolean  @default(false)
  plannedLifetimeYears Int      @default(5)
  isConstellation      Boolean  @default(false)
  constellationSize    Int?
  launchDate           DateTime?
  countryOfRegistry    String?

  // Disposal Planning
  deorbitStrategy      String?  // active_deorbit, passive_decay, graveyard_orbit, adr_contracted
  deorbitTimelineYears Int?
  passivationPlan      Boolean  @default(false)

  // Collision Avoidance
  caServiceProvider    String?
  caServiceActive      Boolean  @default(false)

  // Calculated Results
  complianceScore      Int?     // 0-100
  mandatoryScore       Int?     // 0-100 (mandatory guidelines only)
  riskLevel            String?  // low, medium, high, critical
  criticalGaps         Int?     // Count of critical non-compliant guidelines
  majorGaps            Int?     // Count of major non-compliant guidelines

  // EU Space Act Cross-References
  euSpaceActOverlapCount Int?   // Number of overlapping articles

  // Report
  reportGenerated      Boolean  @default(false)
  reportGeneratedAt    DateTime?

  // Relations
  guidelineStatuses    CopuosGuidelineStatus[]

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@index([orbitRegime])
  @@index([status])
}

model CopuosGuidelineStatus {
  id            String           @id @default(cuid())
  assessmentId  String
  assessment    CopuosAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  guidelineId   String   // matches CopuosGuideline.id from data file
  status        String   @default("not_assessed") // compliant, partial, non_compliant, not_assessed, not_applicable
  notes         String?  @db.Text
  evidenceNotes String?  @db.Text
  targetDate    DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([assessmentId, guidelineId])
  @@index([assessmentId])
  @@index([status])
}

// ─── UK Space Industry Act Models ───

model UkSpaceAssessment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Assessment Info
  assessmentName       String?
  status               String   @default("draft") // draft, in_progress, completed, archived

  // Operator Profile
  operatorType         String   // launch_operator, return_operator, satellite_operator, spaceport_operator, range_control
  activityTypes        String   // JSON array of activity types
  launchFromUk         Boolean  @default(false)
  launchToOrbit        Boolean  @default(false)
  isSuborbital         Boolean  @default(false)
  hasUkNexus           Boolean  @default(true)
  involvesPeople       Boolean  @default(false)
  isCommercial         Boolean  @default(true)

  // Spacecraft/Mission Details
  spacecraftName       String?
  spacecraftMassKg     Float?
  plannedLaunchSite    String?
  targetOrbit          String?
  missionDurationYears Int?

  // License Information
  requiredLicenses     String?  // JSON array of required license types
  licenseApplications  String?  // JSON object tracking license application statuses

  // Safety Case
  safetyCaseStatus     String?  // not_started, in_development, submitted, approved
  safetyCaseRef        String?

  // Insurance
  insuranceProvider    String?
  insuranceCoverage    Float?   // Amount in GBP
  insuranceConfirmed   Boolean  @default(false)

  // Registration
  ukRegistryRef        String?  // UK Space Registry reference
  registrationStatus   String?  // pending, registered, updated

  // Calculated Results
  complianceScore      Int?     // 0-100
  mandatoryScore       Int?     // 0-100 (mandatory requirements only)
  riskLevel            String?  // low, medium, high, critical
  criticalGaps         Int?     // Count of critical non-compliant requirements
  majorGaps            Int?     // Count of major non-compliant requirements

  // EU Space Act Cross-References
  euSpaceActOverlapCount Int?   // Number of overlapping articles

  // Report
  reportGenerated      Boolean  @default(false)
  reportGeneratedAt    DateTime?

  // CAA Documentation
  caaDocChecklistJson  String?  @db.Text // JSON - CAA documentation checklist status

  // Relations
  requirementStatuses  UkRequirementStatus[]

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@index([operatorType])
  @@index([status])
}

model UkRequirementStatus {
  id            String           @id @default(cuid())
  assessmentId  String
  assessment    UkSpaceAssessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  requirementId String   // matches UkSpaceRequirement.id from data file
  status        String   @default("not_assessed") // compliant, partial, non_compliant, not_assessed, not_applicable
  notes         String?  @db.Text
  evidenceNotes String?  @db.Text
  targetDate    DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([assessmentId, requirementId])
  @@index([assessmentId])
  @@index([status])
}

// ─── US Space Regulatory Assessment Models ───

model UsRegulatoryAssessment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Assessment Info
  assessmentName       String?
  status               String   @default("draft") // draft, in_progress, completed, archived

  // Operator Profile
  operatorTypes        String   // JSON array of operator types
  activityTypes        String   // JSON array of activity types
  agencies             String   // JSON array of required agencies (FCC, FAA, NOAA)
  isUsEntity           Boolean  @default(true)
  usNexus              String   @default("us_licensed") // us_licensed, us_operated, us_launched, us_market_access

  // Orbit/Mission Details
  orbitRegime          String?  // LEO, MEO, GEO, HEO, cislunar, deep_space
  altitudeKm           Int?
  frequencyBands       String?  // JSON array
  satelliteCount       Int?
  hasManeuverability   Boolean  @default(false)
  hasPropulsion        Boolean  @default(false)
  missionDurationYears Int?
  isConstellation      Boolean  @default(false)
  isSmallSatellite     Boolean  @default(false)
  isNGSO               Boolean  @default(true)

  // Remote Sensing
  providesRemoteSensing      Boolean @default(false)
  remoteSensingResolutionM   Float?
  noaaTierClassification     String? // tier1, tier2, tier3

  // Launch Details (for FAA)
  launchVehicle        String?
  launchSite           String?
  launchDate           DateTime?

  // FCC License Status
  fccSpaceStationLicense     String?  // not_started, applied, granted, denied
  fccSpaceStationLicenseNo   String?
  fccSpectrumLicense         String?
  fccSpectrumLicenseNo       String?
  fccDebrisPlanStatus        String?  // not_submitted, submitted, approved

  // FAA License Status
  faaLaunchLicense           String?
  faaLaunchLicenseNo         String?
  faaReentryLicense          String?
  faaSiteOperatorLicense     String?
  faaFinancialResponsibility String?  // not_obtained, in_process, obtained

  // NOAA License Status
  noaaRemoteSensingLicense   String?
  noaaLicenseNo              String?

  // Insurance/Financial
  insuranceProvider          String?
  insuranceCoverageUsd       Float?
  insuranceConfirmed         Boolean @default(false)
  mplDetermination           Float?  // FAA Maximum Probable Loss

  // Deorbit Planning
  plannedDisposalYears       Int?
  deorbitStrategy            String?  // active_deorbit, passive_decay, graveyard_orbit
  deorbitCapabilityConfirmed Boolean @default(false)

  // Calculated Results - Per Agency
  fccComplianceScore         Int?     // 0-100
  faaComplianceScore         Int?     // 0-100
  noaaComplianceScore        Int?     // 0-100

  // Overall Calculated Results
  overallComplianceScore     Int?     // 0-100
  mandatoryScore             Int?     // 0-100 (mandatory requirements only)
  riskLevel                  String?  // low, medium, high, critical
  criticalGaps               Int?     // Count of critical non-compliant requirements
  majorGaps                  Int?     // Count of major non-compliant requirements

  // Cross-References
  euSpaceActOverlapCount     Int?     // Number of overlapping EU Space Act articles
  copuosOverlapCount         Int?     // Number of overlapping COPUOS guidelines

  // Report
  reportGenerated            Boolean  @default(false)
  reportGeneratedAt          DateTime?

  // Documentation Checklist (JSON)
  documentationChecklistJson String?  @db.Text

  // Relations
  requirementStatuses        UsRequirementStatus[]

  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([orbitRegime])
}

model UsRequirementStatus {
  id            String                  @id @default(cuid())
  assessmentId  String
  assessment    UsRegulatoryAssessment  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  requirementId String   // matches UsRequirement.id from data file
  status        String   @default("not_assessed") // compliant, partial, non_compliant, not_assessed, not_applicable
  notes         String?  @db.Text
  evidenceNotes String?  @db.Text
  targetDate    DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([assessmentId, requirementId])
  @@index([assessmentId])
  @@index([status])
}

// ─── Export Control (ITAR/EAR) ───

model ExportControlAssessment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Assessment Info
  assessmentName       String?
  status               String   @default("draft") // draft, in_progress, completed, archived

  // Company Profile
  companyTypes         String   // JSON array: spacecraft_manufacturer, satellite_operator, etc.
  hasITARItems         Boolean  @default(false)
  hasEARItems          Boolean  @default(false)
  hasForeignNationals  Boolean  @default(false)
  foreignNationalCountries String? // JSON array of country codes
  exportsToCountries   String?  // JSON array of country codes
  hasTechnologyTransfer Boolean @default(false)
  hasDefenseContracts  Boolean  @default(false)
  hasManufacturingAbroad Boolean @default(false)
  hasJointVentures     Boolean  @default(false)
  annualExportValue    Float?

  // Registration & Compliance Infrastructure
  registeredWithDDTC   Boolean  @default(false)
  ddtcRegistrationNo   String?
  ddtcRegistrationExpiry DateTime?
  hasTCP               Boolean  @default(false) // Technology Control Plan
  tcpLastReviewDate    DateTime?
  hasECL               Boolean  @default(false) // Export Control Licensing System
  hasAutomatedScreening Boolean @default(false)
  screeningVendor      String?

  // Empowered Official (ITAR)
  empoweredOfficialName  String?
  empoweredOfficialEmail String?
  empoweredOfficialTitle String?

  // Jurisdiction Determination
  jurisdictionDetermination String? // itar_only, ear_only, dual_use, itar_with_ear_parts, ear99
  jurisdictionDeterminationDate DateTime?
  hasCJRequest         Boolean  @default(false) // Commodity Jurisdiction request pending/completed
  cjRequestDate        DateTime?
  cjDeterminationDate  DateTime?
  cjDetermination      String?  // Result of CJ request

  // ITAR Licensing Status
  activeITARLicenses   Int?     // Count of active ITAR licenses
  pendingITARLicenses  Int?     // Count of pending ITAR license applications
  activeTAAs           Int?     // Count of active TAAs
  activeMLAs           Int?     // Count of active MLAs

  // EAR Licensing Status
  activeEARLicenses    Int?     // Count of active BIS licenses
  pendingEARLicenses   Int?     // Count of pending BIS license applications
  usesLicenseExceptions Boolean @default(false)
  licenseExceptionsUsed String? // JSON array: TMP, RPL, GOV, TSR, STA, etc.

  // Training & Audit
  lastTrainingDate     DateTime?
  nextTrainingDue      DateTime?
  trainingCompletionRate Float?  // 0-100%
  lastAuditDate        DateTime?
  nextAuditDue         DateTime?
  lastAuditFindings    String?  @db.Text // Summary of findings

  // Voluntary Disclosure History
  hasVoluntaryDisclosures Boolean @default(false)
  voluntaryDisclosureCount Int?
  lastVoluntaryDisclosureDate DateTime?

  // Calculated Results - By Regulation
  itarComplianceScore  Int?     // 0-100
  earComplianceScore   Int?     // 0-100

  // Overall Calculated Results
  overallComplianceScore Int?   // 0-100
  mandatoryScore       Int?     // 0-100 (mandatory requirements only)
  criticalScore        Int?     // 0-100 (critical risk requirements only)
  riskLevel            String?  // low, medium, high, critical
  criticalGaps         Int?     // Count of critical gaps
  highGaps             Int?     // Count of high-risk gaps

  // Penalty Exposure (calculated)
  maxCivilPenalty      Float?   // Max civil penalty exposure
  maxCriminalPenalty   Float?   // Max criminal penalty exposure
  maxImprisonment      Int?     // Max imprisonment in years

  // Report
  reportGenerated      Boolean  @default(false)
  reportGeneratedAt    DateTime?

  // Documentation Checklist (JSON)
  documentationChecklistJson String? @db.Text

  // Relations
  requirementStatuses  ExportControlRequirementStatus[]

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([riskLevel])
  @@index([hasITARItems])
  @@index([hasEARItems])
}

model ExportControlRequirementStatus {
  id            String                    @id @default(cuid())
  assessmentId  String
  assessment    ExportControlAssessment   @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  requirementId String   // matches ExportControlRequirement.id from data file
  status        String   @default("not_assessed") // compliant, partial, non_compliant, not_assessed, not_applicable
  notes         String?  @db.Text
  evidenceNotes String?  @db.Text
  targetDate    DateTime?
  responsibleParty String? // Person/team responsible for this requirement

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([assessmentId, requirementId])
  @@index([assessmentId])
  @@index([status])
}

// ─── Spectrum Management & ITU Compliance ───

model SpectrumAssessment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Assessment Info
  assessmentName       String?
  status               String   @default("draft") // draft, in_progress, completed, archived

  // Network/Mission Profile
  networkName          String?
  operatorName         String?
  orbitType            String   // GEO, NGSO_LEO, NGSO_MEO, NGSO_HEO
  altitudeKm           Int?
  inclinationDeg       Float?
  satelliteCount       Int      @default(1)
  isConstellation      Boolean  @default(false)
  administrationCode   String?  // ITU notifying administration (e.g., F, D, G, USA)

  // Service Types (JSON array)
  serviceTypes         String   // JSON: ["FSS", "MSS", "BSS", "EESS", etc.]

  // Frequency Bands (JSON array)
  frequencyBands       String   // JSON: ["Ku", "Ka", "V", "L", etc.]

  // Frequency Details (JSON object with band-specific info)
  frequencyDetails     String?  @db.Text // JSON: { "Ku": { uplinkMHz: [14000, 14500], downlinkMHz: [11700, 12200], bandwidthMHz: 500 }, ... }

  // EPFD Compliance (for NGSO)
  requiresEPFD         Boolean  @default(false)
  epfdCompliant        Boolean?
  epfdStudyCompleted   Boolean  @default(false)
  epfdStudyDate        DateTime?

  // ITU Filing Status (per phase)
  apiStatus            String   @default("not_started") // not_started, in_preparation, submitted, published, extended
  apiFilingDate        DateTime?
  apiPublicationDate   DateTime?
  apiExpiryDate        DateTime?
  apiReference         String?

  crCStatus            String   @default("not_started") // not_started, in_preparation, submitted, published
  crCFilingDate        DateTime?
  crCPublicationDate   DateTime?
  crCReference         String?

  notificationStatus   String   @default("not_started") // not_started, in_preparation, submitted, examined, favorable, unfavorable
  notificationFilingDate DateTime?
  notificationExaminationDate DateTime?
  notificationReference String?

  recordingStatus      String   @default("not_started") // not_started, pending, recorded, suspended
  recordingDate        DateTime?
  recordingReference   String?
  mfrnReference        String?  // Master International Frequency Register reference

  // Due Diligence / Bringing into Use
  biuDeadline          DateTime?
  biuAchieved          Boolean  @default(false)
  biuDate              DateTime?
  biuEvidenceDocument  String?  // Reference to uploaded evidence

  // NGSO Milestones (for NGSO systems)
  milestone10Percent   DateTime? // 10% of constellation deployed
  milestone50Percent   DateTime? // 50% of constellation deployed
  milestone100Percent  DateTime? // 100% of constellation deployed
  milestone10Achieved  Boolean   @default(false)
  milestone50Achieved  Boolean   @default(false)
  milestone100Achieved Boolean   @default(false)

  // Coordination Status (JSON object)
  coordinationStatus   String?  @db.Text // JSON: { "affectedAdmins": [...], "coordinations": { "USA": { status: "in_progress", date: "...", notes: "..." }, ... } }
  hasCoordinationAgreements Boolean @default(false)
  coordinationAgreementsJson String? @db.Text // JSON array of coordination agreements

  // Jurisdiction Licenses (JSON object tracking licenses per jurisdiction)
  jurisdictionLicenses String?  @db.Text // JSON: { "ITU": { status: "recorded", reference: "..." }, "FCC": { status: "granted", licenseNo: "..." }, ... }

  // Multi-jurisdiction tracking
  primaryJurisdiction  String?  // Primary licensing authority (ITU region or country code)
  additionalJurisdictions String? // JSON array of additional jurisdictions requiring licenses

  // WRC Compliance
  wrcDecisionsApplicable String? // JSON array of applicable WRC decision IDs
  wrcCompliant         Boolean?

  // Interference
  interferenceAnalysisComplete Boolean @default(false)
  interferenceAnalysisDate DateTime?
  identifiedInterferenceRisks String? @db.Text // JSON array of identified risks
  mitigationMeasures   String?  @db.Text // JSON array of mitigation measures

  // Calculated Results - By Source
  ituComplianceScore   Int?     // 0-100
  nationalComplianceScore Int?  // 0-100

  // Overall Calculated Results
  overallComplianceScore Int?   // 0-100
  mandatoryScore       Int?     // 0-100 (mandatory requirements only)
  criticalScore        Int?     // 0-100 (critical requirements only)
  riskLevel            String?  // low, medium, high, critical
  criticalGaps         Int?     // Count of critical gaps
  highGaps             Int?     // Count of high-risk gaps

  // Filing Timeline (calculated)
  totalFilingDurationMonths Int? // Estimated total duration in months
  nextMilestoneDate    DateTime?
  nextMilestoneDescription String?

  // Cross-References
  euSpaceActOverlapCount Int?   // Number of overlapping EU Space Act articles
  usRegulatoryOverlapCount Int? // Number of overlapping US regulatory requirements

  // Report
  reportGenerated      Boolean  @default(false)
  reportGeneratedAt    DateTime?

  // Documentation Checklist (JSON)
  documentationChecklistJson String? @db.Text

  // Relations
  requirementStatuses  SpectrumRequirementStatus[]

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([orbitType])
  @@index([administrationCode])
}

model SpectrumRequirementStatus {
  id            String              @id @default(cuid())
  assessmentId  String
  assessment    SpectrumAssessment  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  requirementId String   // matches SpectrumRequirement.id from data file
  status        String   @default("not_assessed") // compliant, partial, non_compliant, not_assessed, not_applicable
  notes         String?  @db.Text
  evidenceNotes String?  @db.Text
  targetDate    DateTime?
  responsibleParty String? // Person/team responsible for this requirement
  filingReference String? // Reference number if related to a filing

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([assessmentId, requirementId])
  @@index([assessmentId])
  @@index([status])
}

// ─── Security Models ───

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String
  success   Boolean  @default(false)
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([email])
  @@index([createdAt])
}

model SecurityEvent {
  id          String   @id @default(cuid())
  type        String   // SUSPICIOUS_ACTIVITY, RATE_LIMIT, FAILED_AUTH, BRUTE_FORCE, etc.
  severity    String   // LOW, MEDIUM, HIGH, CRITICAL
  description String   @db.Text
  metadata    String?  @db.Text // JSON
  resolved    Boolean  @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?
  createdAt   DateTime @default(now())

  @@index([type])
  @@index([severity])
  @@index([createdAt])
  @@index([resolved])
}

// ─── Supervision & Reporting ───

model SupervisionConfig {
  id                     String   @id @default(cuid())
  userId                 String   @unique
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // NCA Configuration
  primaryCountry         String
  additionalCountries    String[] @default([])
  designatedContactName  String?
  designatedContactEmail String?
  designatedContactPhone String?
  designatedContactRole  String?
  communicationLanguage  String   @default("en")
  notificationMethod     String   @default("email") // email, portal, both

  // Reporting Preferences
  enableAutoReminders    Boolean  @default(true)
  reminderDaysAdvance    Int      @default(14)

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  incidents              Incident[]
  reports                SupervisionReport[]
  calendarEvents         SupervisionCalendarEvent[]
}

model Incident {
  id                String            @id @default(cuid())
  supervisionId     String
  supervision       SupervisionConfig @relation(fields: [supervisionId], references: [id], onDelete: Cascade)

  incidentNumber    String            @unique // INC-2026-001
  category          String            // spacecraft_anomaly, loss_of_contact, conjunction_event, debris_generation, cyber_incident, regulatory_breach
  severity          String            // critical, high, medium, low
  status            String            @default("detected") // detected, investigating, contained, resolved, reported

  // Detection
  detectedAt        DateTime
  detectedBy        String
  detectionMethod   String            // automated, manual, external_report

  // Description
  title             String
  description       String            @db.Text
  rootCause         String?           @db.Text
  impactAssessment  String?           @db.Text

  // Response
  immediateActions  String[]          @default([])
  containmentMeasures String[]        @default([])
  resolutionSteps   String[]          @default([])
  lessonsLearned    String?           @db.Text

  // NCA Reporting
  requiresNCANotification Boolean     @default(true)
  reportedToNCA     Boolean           @default(false)
  ncaReportDate     DateTime?
  ncaReferenceNumber String?
  reportedToEUSPA   Boolean           @default(false)
  euspaReportDate   DateTime?

  // Timeline
  containedAt       DateTime?
  resolvedAt        DateTime?

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  affectedAssets    IncidentAsset[]
  attachments       IncidentAttachment[]
  reports           SupervisionReport[]

  @@index([supervisionId])
  @@index([category])
  @@index([severity])
  @@index([status])
  @@index([detectedAt])
}

model IncidentAsset {
  id         String   @id @default(cuid())
  incidentId String
  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  cosparId   String?
  noradId    String?
  assetName  String

  @@index([incidentId])
}

model IncidentAttachment {
  id         String   @id @default(cuid())
  incidentId String
  incident   Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  filename   String
  fileType   String
  fileSize   Int
  filePath   String
  uploadedAt DateTime @default(now())

  @@index([incidentId])
}

model SupervisionReport {
  id             String            @id @default(cuid())
  supervisionId  String
  supervision    SupervisionConfig @relation(fields: [supervisionId], references: [id], onDelete: Cascade)

  reportType     String            // annual_compliance, significant_change, incident, cybersecurity, debris_event, conjunction, anomaly, eol_update, insurance, ownership_transfer
  reportPeriod   String?           // e.g., "2025", "Q1 2026"
  status         String            @default("draft") // draft, generated, ready, submitted, acknowledged, rejected, archived
  dueDate        DateTime?
  submittedAt    DateTime?
  acknowledgedAt DateTime?
  rejectedAt     DateTime?
  rejectionReason String?          @db.Text

  // Content
  title          String?
  content        String?           @db.Text // JSON structured report content
  ncaReferenceNumber String?
  fileUrl        String?           // URL to stored PDF file
  metadata       Json?             // Additional report metadata

  // Generation
  generatedAt    DateTime?
  generatedBy    String?
  generator      User?             @relation("GeneratedReports", fields: [generatedBy], references: [id])

  // Incident link (for incident reports)
  incidentId     String?
  incident       Incident?         @relation(fields: [incidentId], references: [id], onDelete: SetNull)

  // NCA Submissions
  ncaSubmissions NCASubmission[]

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([supervisionId])
  @@index([reportType])
  @@index([dueDate])
  @@index([status])
  @@index([incidentId])
  @@index([generatedBy])
}

model SupervisionCalendarEvent {
  id             String            @id @default(cuid())
  supervisionId  String
  supervision    SupervisionConfig @relation(fields: [supervisionId], references: [id], onDelete: Cascade)

  eventType      String            // report_due, inspection_scheduled, audit_scheduled, authorization_renewal, insurance_renewal, certification_expiry, regulatory_deadline, internal_review
  title          String
  description    String?           @db.Text
  dueDate        DateTime
  reminderDays   Int[]             @default([14, 7, 1])
  assignee       String?
  status         String            @default("upcoming") // upcoming, in_progress, completed, overdue, cancelled

  linkedReportId String?
  linkedAssetIds String[]          @default([])
  notes          String?           @db.Text

  completedAt    DateTime?

  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([supervisionId])
  @@index([dueDate])
  @@index([status])
  @@index([eventType])
}

// ============================================
// TIMELINE & DEADLINES MODULE
// ============================================

model Deadline {
  id              String           @id @default(cuid())
  userId          String
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  title           String
  description     String?          @db.Text
  dueDate         DateTime
  category        DeadlineCategory
  priority        Priority
  status          DeadlineStatus   @default(UPCOMING)

  // Source tracking
  moduleSource    ModuleType?      // Which module created this deadline
  relatedEntityId String?          // e.g., Mission ID, License ID

  // Reminders
  reminderDays    Int[]            @default([30, 14, 7, 3, 1])
  remindersSent   DateTime[]

  // Recurring
  isRecurring     Boolean          @default(false)
  recurrenceRule  String?          // RRULE format (iCal)
  parentId        String?
  parent          Deadline?        @relation("RecurringDeadlines", fields: [parentId], references: [id])
  children        Deadline[]       @relation("RecurringDeadlines")

  // Responsibility
  assignedTo      String?
  assignedTeam    String?

  // Compliance
  regulatoryRef   String?          // e.g., "EU Space Act Art. 45"
  penaltyInfo     String?          @db.Text // Consequences if missed

  // Meta
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  completedAt     DateTime?
  completedBy     String?
  completionNotes String?          @db.Text

  // Extension tracking
  originalDueDate DateTime?
  extensionReason String?          @db.Text
  extensionApprovedBy String?

  @@index([userId, dueDate])
  @@index([status, dueDate])
  @@index([category])
  @@index([moduleSource])
  @@index([parentId])
  @@index([userId, status, dueDate])
}

model MissionPhase {
  id              String       @id @default(cuid())
  userId          String
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  missionId       String
  missionName     String?
  name            String
  description     String?      @db.Text
  startDate       DateTime
  endDate         DateTime
  status          PhaseStatus  @default(PLANNED)
  progress        Int          @default(0) // 0-100

  // Dependencies (IDs of predecessor phases)
  dependsOn       String[]     @default([])

  // Color for Gantt chart
  color           String?

  // Milestones
  milestones      Milestone[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([userId, missionId])
  @@index([status])
}

model Milestone {
  id              String          @id @default(cuid())
  phaseId         String
  phase           MissionPhase    @relation(fields: [phaseId], references: [id], onDelete: Cascade)

  name            String
  description     String?         @db.Text
  targetDate      DateTime
  completedDate   DateTime?
  status          MilestoneStatus @default(PENDING)

  isCritical      Boolean         @default(false)
  isRegulatory    Boolean         @default(false)
  regulatoryRef   String?
  icon            String?         // e.g., "rocket", "check", "flag"

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([phaseId, targetDate])
  @@index([status])
}

enum DeadlineCategory {
  REGULATORY      // Government/authority deadlines
  LICENSE         // License/permit deadlines
  REPORTING       // Report submission deadlines
  INSURANCE       // Insurance deadlines
  CERTIFICATION   // Certification deadlines
  MISSION         // Mission-related deadlines
  INTERNAL        // Internal deadlines
  CONTRACTUAL     // Contractual deadlines
}

enum Priority {
  CRITICAL        // Must be met, severe consequences otherwise
  HIGH            // Important, address promptly
  MEDIUM          // Standard priority
  LOW             // Nice-to-have
}

enum DeadlineStatus {
  UPCOMING        // Still time remaining
  DUE_SOON        // Due soon (< 7 days)
  OVERDUE         // Past due date
  COMPLETED       // Done
  CANCELLED       // Cancelled
  EXTENDED        // Extended with new due date
}

enum PhaseStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  DELAYED
  ON_HOLD
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  MISSED
  RESCHEDULED
}

enum ModuleType {
  AUTHORIZATION
  DEBRIS
  INSURANCE
  CYBERSECURITY
  ENVIRONMENTAL
  SUPERVISION
  REGISTRATION
  TIMELINE
  DOCUMENTS
  NIS2
}

// ============================================
// DOCUMENT VAULT MODULE
// ============================================

model Document {
  id                String            @id @default(cuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Basic Information
  name              String
  description       String?           @db.Text
  fileName          String
  fileSize          Int               // in bytes
  mimeType          String

  // Categorization
  category          DocumentCategory
  subcategory       String?
  tags              String[]          @default([])

  // Storage
  storagePath       String            // Path in secure storage
  storageProvider   String?           // Storage provider: R2, S3, LOCAL, etc.
  checksum          String            // SHA-256 for integrity

  // Versioning
  version           Int               @default(1)
  isLatest          Boolean           @default(true)
  parentId          String?
  parent            Document?         @relation("DocumentVersions", fields: [parentId], references: [id])
  versions          Document[]        @relation("DocumentVersions")

  // Expiry & Validity
  issueDate         DateTime?
  expiryDate        DateTime?
  isExpired         Boolean           @default(false)
  expiryAlertDays   Int[]             @default([90, 30, 14, 7])

  // Compliance Linking
  moduleType        ModuleType?
  relatedEntityId   String?           // e.g., Mission ID, License ID
  regulatoryRef     String?           // e.g., "EU Space Act Art. 7"

  // Access Control
  accessLevel       AccessLevel       @default(INTERNAL)
  allowedUserIds    String[]          @default([])
  allowedRoles      String[]          @default([])

  // Status
  status            DocumentStatus    @default(DRAFT)
  reviewedBy        String?
  reviewedAt        DateTime?
  approvedBy        String?
  approvedAt        DateTime?

  // Meta
  uploadedBy        String
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  accessLogs        DocumentAccessLog[]
  comments          DocumentComment[]
  shares            DocumentShare[]
  complianceEvidenceLinks ComplianceEvidenceDocument[]  // Audit Center: evidence-to-document links

  @@index([userId, category])
  @@index([expiryDate])
  @@index([status])
  @@index([moduleType])
  @@index([userId, status, expiryDate])
}

model DocumentAccessLog {
  id           String         @id @default(cuid())
  documentId   String
  document     Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)

  userId       String
  action       AccessAction
  ipAddress    String?
  userAgent    String?
  details      String?        @db.Text // JSON details

  createdAt    DateTime       @default(now())

  @@index([documentId, createdAt])
  @@index([userId, createdAt])
}

model DocumentComment {
  id           String    @id @default(cuid())
  documentId   String
  document     Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  userId       String
  userName     String?
  content      String    @db.Text

  // Replies
  parentId     String?
  parent       DocumentComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies      DocumentComment[] @relation("CommentReplies")

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([documentId, createdAt])
}

model DocumentShare {
  id           String    @id @default(cuid())
  documentId   String
  document     Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)

  // Share Settings
  sharedWith   String?   // Email or User ID
  shareToken   String    @unique
  accessType   ShareAccessType

  // Restrictions
  expiresAt    DateTime?
  maxDownloads Int?
  downloadCount Int      @default(0)
  password     String?   // Optional password protection (hashed)

  // Tracking
  createdBy    String
  createdAt    DateTime  @default(now())
  lastAccessed DateTime?

  @@index([shareToken])
  @@index([documentId])
}

model DocumentTemplate {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  name            String
  description     String?           @db.Text
  category        DocumentCategory

  // Template file
  templatePath    String
  templateContent String?           @db.Text // For text-based templates

  // Placeholders (JSON)
  placeholders    String            @db.Text // JSON: { "COMPANY_NAME": { type: "string", required: true } }

  // Compliance
  regulatoryRef   String?
  requiredFields  String[]          @default([])

  isSystem        Boolean           @default(false) // System-provided template

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, category])
}

enum DocumentCategory {
  // Licenses & Permits
  LICENSE
  PERMIT
  AUTHORIZATION

  // Certificates
  CERTIFICATE
  ISO_CERTIFICATE
  SECURITY_CERT

  // Insurance
  INSURANCE_POLICY
  INSURANCE_CERT

  // Reports
  COMPLIANCE_REPORT
  AUDIT_REPORT
  INCIDENT_REPORT
  ANNUAL_REPORT

  // Technical Documents
  TECHNICAL_SPEC
  DESIGN_DOC
  TEST_REPORT
  SAFETY_ANALYSIS

  // Contracts
  CONTRACT
  NDA
  SLA

  // Regulatory Communications
  REGULATORY_FILING
  CORRESPONDENCE
  NOTIFICATION

  // Internal Documents
  POLICY
  PROCEDURE
  TRAINING

  // Other
  OTHER
}

enum DocumentStatus {
  DRAFT
  PENDING_REVIEW
  UNDER_REVIEW
  PENDING_APPROVAL
  APPROVED
  ACTIVE
  EXPIRED
  SUPERSEDED
  ARCHIVED
  REJECTED
}

enum AccessLevel {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  RESTRICTED
  TOP_SECRET
}

enum AccessAction {
  VIEW
  DOWNLOAD
  PRINT
  SHARE
  EDIT
  DELETE
  RESTORE
  VERSION_CREATED
  PERMISSION_CHANGED
  COMMENT_ADDED
}

enum ShareAccessType {
  VIEW_ONLY
  DOWNLOAD
  COMMENT
  EDIT
}

// ============================================
// NOTIFICATION SYSTEM
// ============================================

model NotificationLog {
  id               String   @id @default(cuid())
  userId           String
  recipientEmail   String
  notificationType String   // deadline_reminder, document_expiry, incident_alert, weekly_digest
  entityType       String   // deadline, document, incident, summary
  entityId         String?  // nullable for digest emails
  subject          String
  status           String   @default("sent") // sent, failed, bounced
  errorMessage     String?  @db.Text
  metadata         String?  @db.Text // JSON for additional data
  sentAt           DateTime @default(now())

  @@index([userId, sentAt])
  @@index([entityType, entityId])
  @@index([status])
  @@index([notificationType])
}

enum NotificationType {
  // Deadlines
  DEADLINE_REMINDER
  DEADLINE_APPROACHING
  DEADLINE_OVERDUE
  DOCUMENT_EXPIRY

  // Compliance
  COMPLIANCE_GAP
  COMPLIANCE_SCORE_DROPPED
  COMPLIANCE_ACTION_REQUIRED
  COMPLIANCE_UPDATED

  // Authorization
  AUTHORIZATION_UPDATE
  WORKFLOW_STATUS_CHANGED
  DOCUMENT_REQUIRED
  AUTHORIZATION_APPROVED
  AUTHORIZATION_REJECTED

  // Incidents
  INCIDENT_ALERT
  INCIDENT_CREATED
  INCIDENT_ESCALATED
  INCIDENT_RESOLVED
  NCA_DEADLINE_APPROACHING

  // Reports
  WEEKLY_DIGEST
  REPORT_GENERATED
  REPORT_SUBMITTED
  REPORT_FAILED
  NCA_ACKNOWLEDGED

  // Team
  MEMBER_JOINED
  MEMBER_LEFT
  MEMBER_ROLE_CHANGED
  INVITATION_RECEIVED

  // Spacecraft
  SPACECRAFT_STATUS_CHANGED
  SPACECRAFT_ADDED

  // System
  SYSTEM_UPDATE
  SYSTEM_MAINTENANCE

  // NIS2
  NIS2_DEADLINE_APPROACHING
  NIS2_ASSESSMENT_UPDATED
}

// ============================================
// SCHEDULED REPORTS & ARCHIVE
// ============================================

model ScheduledReport {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Report Configuration
  name           String              // User-friendly name for this schedule
  reportType     ScheduledReportType // Type of report to generate
  schedule       String              // Cron expression: "0 0 1 * *" (monthly on 1st)
  timezone       String   @default("UTC")

  // Timing
  nextRunAt      DateTime
  lastRunAt      DateTime?
  lastRunStatus  String?             // success, failed, skipped

  // Recipients
  recipients     String[]            // Email addresses for delivery
  sendToSelf     Boolean  @default(true)

  // Output Options
  format         ReportFormat @default(PDF)
  includeCharts  Boolean  @default(true)

  // Filters (JSON)
  filters        String?  @db.Text   // Module filters, date ranges, etc.

  // Status
  isActive       Boolean  @default(true)
  failureCount   Int      @default(0)
  maxRetries     Int      @default(3)

  // Relations
  archives       ReportArchive[]

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
  @@index([nextRunAt, isActive])
  @@index([reportType])
}

model ReportArchive {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Report Info
  reportType        ScheduledReportType
  title             String
  description       String?  @db.Text

  // File Storage
  fileName          String
  fileSize          Int               // in bytes
  mimeType          String
  storagePath       String            // Path to stored file
  checksum          String            // SHA-256 for integrity

  // Generation Context
  generatedAt       DateTime
  generationTimeMs  Int?              // How long it took to generate
  scheduledReportId String?           // Link to schedule if auto-generated
  scheduledReport   ScheduledReport?  @relation(fields: [scheduledReportId], references: [id], onDelete: SetNull)

  // Report Period
  periodStart       DateTime?
  periodEnd         DateTime?

  // Metadata
  metadata          String?  @db.Text // JSON: filters used, data snapshot, etc.

  // Retention
  expiresAt         DateTime?         // Auto-cleanup date
  isArchived        Boolean  @default(false) // Marked for long-term storage

  // Download Tracking
  downloadCount     Int      @default(0)
  lastDownloadedAt  DateTime?

  createdAt         DateTime @default(now())

  @@index([userId])
  @@index([reportType])
  @@index([generatedAt])
  @@index([scheduledReportId])
  @@index([expiresAt])
}

enum ScheduledReportType {
  COMPLIANCE_SUMMARY      // Overall compliance status
  MONTHLY_DIGEST          // Monthly activity digest
  QUARTERLY_REVIEW        // Quarterly compliance review
  ANNUAL_COMPLIANCE       // Annual compliance report
  INCIDENT_DIGEST         // Incident summary report
  AUTHORIZATION_STATUS    // Authorization workflow status
  DOCUMENT_INVENTORY      // Document status report
  DEADLINE_FORECAST       // Upcoming deadlines report
  AUDIT_TRAIL             // Audit log export
  COMPLIANCE_CERTIFICATE  // Compliance certificate
}

enum ReportFormat {
  PDF
  CSV
  JSON
  XLSX
}

// ============================================
// NCA SUBMISSION TRACKING
// ============================================

model NCASubmission {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Report Link
  reportId          String
  report            SupervisionReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  // NCA Information
  ncaAuthority      NCAAuthority      // Target NCA
  ncaAuthorityName  String            // Full name for display
  ncaPortalUrl      String?           // Link to NCA portal if applicable

  // Submission Details
  submissionMethod  SubmissionMethod
  submittedAt       DateTime
  submittedBy       String            // User ID who submitted

  // Attachments
  attachments       Json?             // List of { fileName, fileSize, fileUrl }
  coverLetter       String?  @db.Text // Optional cover letter content

  // Status Tracking
  status            NCASubmissionStatus @default(SUBMITTED)
  statusHistory     Json?             // Array of { status, timestamp, notes }

  // NCA Response
  ncaReference      String?           // NCA-assigned reference number
  acknowledgedAt    DateTime?
  acknowledgedBy    String?           // NCA contact name
  rejectedAt        DateTime?
  rejectionReason   String?  @db.Text

  // Follow-up
  responseNotes     String?  @db.Text // Notes from NCA response
  followUpRequired  Boolean  @default(false)
  followUpDeadline  DateTime?
  followUpNotes     String?  @db.Text

  // Resend tracking
  originalSubmissionId String?        // If this is a resend, link to original
  originalSubmission   NCASubmission? @relation("SubmissionResends", fields: [originalSubmissionId], references: [id])
  resends              NCASubmission[] @relation("SubmissionResends")
  resendCount       Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@index([reportId])
  @@index([ncaAuthority])
  @@index([status])
  @@index([submittedAt])
  @@index([originalSubmissionId])
}

enum NCAAuthority {
  // EU Member States
  DE_BMWK           // Germany - Federal Ministry for Economic Affairs
  DE_DLR            // Germany - German Aerospace Center
  FR_CNES           // France - Centre National d'Études Spatiales
  FR_DGAC           // France - Direction Générale de l'Aviation Civile
  IT_ASI            // Italy - Agenzia Spaziale Italiana
  ES_AEE            // Spain - Agencia Espacial Española
  NL_NSO            // Netherlands - Netherlands Space Office
  BE_BELSPO         // Belgium - Belgian Science Policy Office
  AT_FFG            // Austria - Austrian Research Promotion Agency
  PL_POLSA          // Poland - Polish Space Agency
  SE_SNSA           // Sweden - Swedish National Space Agency
  DK_DTU            // Denmark - DTU Space
  FI_BF             // Finland - Business Finland
  PT_FCT            // Portugal - Fundação para a Ciência e a Tecnologia
  IE_EI             // Ireland - Enterprise Ireland
  LU_LSA            // Luxembourg - Luxembourg Space Agency
  CZ_CSO            // Czech Republic - Czech Space Office
  RO_ROSA           // Romania - Romanian Space Agency
  GR_HSA            // Greece - Hellenic Space Agency
  // EU Level
  EUSPA             // EU Space Programme Agency
  EC_DEFIS          // European Commission DG DEFIS
  // Other
  OTHER             // Other authority
}

enum SubmissionMethod {
  PORTAL            // Via NCA online portal
  EMAIL             // Via official email
  API               // Via API integration
  REGISTERED_MAIL   // Physical registered mail
  IN_PERSON         // In-person submission
}

enum NCASubmissionStatus {
  DRAFT             // Preparing submission
  SUBMITTED         // Sent to NCA
  RECEIVED          // NCA confirmed receipt
  UNDER_REVIEW      // NCA is reviewing
  INFORMATION_REQUESTED // NCA requested additional info
  ACKNOWLEDGED      // NCA formally acknowledged
  APPROVED          // NCA approved (for authorizations)
  REJECTED          // NCA rejected
  WITHDRAWN         // Operator withdrew submission
}

// ============================================
// MULTI-TENANCY: ORGANIZATIONS
// ============================================

model Organization {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique  // URL-friendly identifier

  // Branding
  logoUrl           String?
  primaryColor      String?  @default("#3B82F6")

  // Settings
  timezone          String   @default("Europe/Berlin")
  defaultLanguage   String   @default("en")

  // Subscription
  plan              OrganizationPlan @default(FREE)
  planExpiresAt     DateTime?
  maxUsers          Int      @default(3)
  maxSpacecraft     Int      @default(5)

  // Billing
  billingEmail      String?
  vatNumber         String?
  billingAddress    Json?

  // Status
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  members           OrganizationMember[]
  invitations       OrganizationInvitation[]
  spacecraft        Spacecraft[]
  registrations     SpaceObjectRegistration[]
  ssoConnection     SSOConnection?
  apiKeys           ApiKey[]
  webhooks          Webhook[]
  subscription      Subscription?
  comments          Comment[]               // Collaboration: organization's comments
  activities        Activity[]              // Collaboration: organization's activities
  complianceEvidence ComplianceEvidence[]   // Audit Center: org-scoped compliance evidence
  astraConversations AstraConversation[]    // ASTRA AI conversations
  healthScore       CustomerHealthScore?    // CEO Analytics: customer health

  @@index([slug])
}

// ============================================
// SUBSCRIPTIONS & BILLING
// ============================================

model Subscription {
  id                   String   @id @default(cuid())
  organizationId       String   @unique
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Stripe IDs
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique
  stripePriceId        String?

  // Status
  status               SubscriptionStatus @default(TRIALING)
  plan                 OrganizationPlan   @default(FREE)

  // Billing Cycle
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean  @default(false)
  canceledAt           DateTime?

  // Trial
  trialStart           DateTime?
  trialEnd             DateTime?

  // Timestamps
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([stripeCustomerId])
  @@index([status])
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
}

model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  role           OrganizationRole @default(MEMBER)
  permissions    String[]  // Granular permissions array

  invitedBy      String?   // User ID who invited this member
  joinedAt       DateTime  @default(now())

  @@unique([organizationId, userId])
  @@index([userId])
  @@index([organizationId])
}

model OrganizationInvitation {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  email          String
  role           OrganizationRole @default(MEMBER)
  token          String   @unique  // Secure invitation token

  invitedBy      String   // User ID who created the invitation
  expiresAt      DateTime
  acceptedAt     DateTime?

  createdAt      DateTime @default(now())

  @@index([token])
  @@index([email])
  @@index([organizationId])
}

enum OrganizationPlan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum OrganizationRole {
  OWNER       // Full access, can delete org
  ADMIN       // Manage members, settings
  MANAGER     // Manage compliance, reports
  MEMBER      // View & edit assigned items
  VIEWER      // Read-only access
}

// ============================================
// SPACECRAFT / ASSET MANAGEMENT
// ============================================

model Spacecraft {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Identification
  name           String
  cosparId       String?  // International designator (e.g., "2024-001A")
  noradId        String?  // NORAD catalog number

  // Mission Info
  missionType    String   // communication, earth_observation, navigation, etc.
  launchDate     DateTime?
  endOfLifeDate  DateTime?

  // Orbital Parameters
  orbitType      String   // LEO, MEO, GEO, HEO
  altitudeKm     Float?
  inclinationDeg Float?

  // Status
  status         SpacecraftStatus @default(PRE_LAUNCH)

  // Metadata
  description    String?  @db.Text
  metadata       Json?    // Flexible additional data

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  registrations  SpaceObjectRegistration[]

  @@index([organizationId])
  @@index([cosparId])
  @@index([noradId])
  @@index([status])
}

enum SpacecraftStatus {
  PRE_LAUNCH
  LAUNCHED
  OPERATIONAL
  DECOMMISSIONING
  DEORBITED
  LOST
}

// ============================================
// URSO REGISTRATION (UN Registry of Space Objects)
// ============================================

model SpaceObjectRegistration {
  id                    String   @id @default(cuid())

  // Core URSO Fields (Art. 24 EU Space Act)
  internationalDesignator String?  // COSPAR ID: YYYY-NNNXXX
  noradCatalogNumber    String?   // 5-digit NORAD ID
  objectName            String    // Official name
  objectType            SpaceObjectType

  // Launch Information
  launchDate            DateTime?
  launchSite            String?   // e.g., "Kourou, French Guiana"
  launchVehicle         String?   // e.g., "Ariane 6"
  launchState           String?   // ISO country code (e.g., "FR")

  // Orbital Parameters
  orbitalRegime         OrbitalRegime
  perigee               Float?    // km
  apogee                Float?    // km
  inclination           Float?    // degrees
  period                Float?    // minutes
  nodeLongitude         Float?    // degrees (for GEO)

  // Ownership & Jurisdiction
  ownerOperator         String    // Organization name
  stateOfRegistry       String    // ISO country code
  jurisdictionState     String?   // If different from registry

  // General Function
  generalFunction       String?   @db.Text // Mission description

  // Status
  status                RegistrationStatus @default(DRAFT)
  submittedAt           DateTime?
  registeredAt          DateTime?
  ursoReference         String?   // Reference number from UN registry
  ncaReference          String?   // National NCA reference

  // Deregistration
  deregisteredAt        DateTime?
  deregistrationReason  String?   @db.Text
  reentryDate           DateTime?

  // Change Tracking
  lastAmendmentDate     DateTime?
  amendmentReason       String?   @db.Text

  // Linkage
  spacecraftId          String
  spacecraft            Spacecraft @relation(fields: [spacecraftId], references: [id], onDelete: Cascade)
  organizationId        String
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Audit
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdBy             String
  submittedBy           String?

  // Relations
  statusHistory         RegistrationStatusHistory[]
  attachments           RegistrationAttachment[]

  @@index([spacecraftId])
  @@index([organizationId])
  @@index([internationalDesignator])
  @@index([status])
  @@index([stateOfRegistry])
}

model RegistrationStatusHistory {
  id             String   @id @default(cuid())
  registrationId String
  registration   SpaceObjectRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  fromStatus     RegistrationStatus?
  toStatus       RegistrationStatus
  changedBy      String
  reason         String?  @db.Text
  metadata       Json?

  createdAt      DateTime @default(now())

  @@index([registrationId, createdAt])
}

model RegistrationAttachment {
  id             String   @id @default(cuid())
  registrationId String
  registration   SpaceObjectRegistration @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  name           String
  description    String?
  fileType       String   // technical_specs, launch_contract, insurance_cert, etc.
  storagePath    String
  fileSize       Int
  mimeType       String

  uploadedBy     String
  uploadedAt     DateTime @default(now())

  @@index([registrationId])
}

enum SpaceObjectType {
  SATELLITE
  SPACE_STATION
  SPACE_PROBE
  CREWED_SPACECRAFT
  LAUNCH_VEHICLE_STAGE
  DEBRIS
  OTHER
}

enum OrbitalRegime {
  LEO      // < 2000 km
  MEO      // 2000 - 35786 km
  GEO      // ~35786 km
  HEO      // Highly Elliptical Orbit
  SSO      // Sun-Synchronous Orbit
  POLAR    // Polar Orbit
  BEYOND   // Lunar, interplanetary
}

enum RegistrationStatus {
  DRAFT
  PENDING_SUBMISSION
  SUBMITTED
  UNDER_REVIEW
  REGISTERED
  AMENDMENT_REQUIRED
  AMENDMENT_PENDING
  DEREGISTERED
  REJECTED
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String?

  // Content
  type           NotificationType
  title          String
  message        String   @db.Text
  actionUrl      String?

  // Metadata
  entityType     String?  // compliance, report, incident, spacecraft, etc.
  entityId       String?
  severity       NotificationSeverity @default(INFO)

  // Status
  read           Boolean  @default(false)
  readAt         DateTime?
  dismissed      Boolean  @default(false)

  // Delivery
  emailSent      Boolean  @default(false)
  emailSentAt    DateTime?

  createdAt      DateTime @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([organizationId])
}

model NotificationPreference {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Channel Preferences
  emailEnabled   Boolean  @default(true)
  pushEnabled    Boolean  @default(true)

  // Category Preferences (JSON: { deadline: { email: true, push: true }, ... })
  categories     Json?

  // Quiet Hours
  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String?  // "22:00"
  quietHoursEnd     String?  // "08:00"
  quietHoursTimezone String? @default("Europe/Berlin")

  // Digest
  digestEnabled  Boolean  @default(false)
  digestFrequency String? // daily, weekly

  updatedAt      DateTime @updatedAt
}

enum NotificationSeverity {
  INFO
  WARNING
  URGENT
  CRITICAL
}

// ============================================
// SSO & SECURITY
// ============================================

model SSOConnection {
  id             String   @id @default(cuid())
  organizationId String   @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Provider
  provider       SSOProvider

  // SAML Config
  entityId       String?
  ssoUrl         String?
  certificate    String?  @db.Text

  // OIDC Config
  clientId       String?
  clientSecret   String?  // Encrypted
  issuerUrl      String?

  // Settings
  autoProvision  Boolean  @default(true)  // Auto-create users on first login
  defaultRole    OrganizationRole @default(MEMBER)

  // Domain Verification
  domains        String[] // Verified email domains for this org
  enforceSSO     Boolean  @default(false) // Block password login for org members

  // Status
  isActive       Boolean  @default(true)
  lastTestedAt   DateTime?
  lastTestResult String?  // success, failed, pending

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

enum SSOProvider {
  SAML
  OIDC
  AZURE_AD
  OKTA
  GOOGLE_WORKSPACE
}

model UserSession {
  id             String   @id @default(cuid())
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session Info
  sessionToken   String   @unique

  // Device Info
  deviceType     String?  // desktop, mobile, tablet
  browser        String?  // Chrome, Firefox, Safari, etc.
  browserVersion String?
  os             String?  // Windows, macOS, Linux, iOS, Android
  osVersion      String?

  // Location Info
  ipAddress      String?
  city           String?
  country        String?
  countryCode    String?

  // Status
  isActive       Boolean  @default(true)
  lastActiveAt   DateTime @default(now())
  expiresAt      DateTime

  // Auth Method
  authMethod     AuthMethod @default(PASSWORD)

  createdAt      DateTime @default(now())
  revokedAt      DateTime?
  revokedReason  String?

  @@index([userId])
  @@index([sessionToken])
  @@index([userId, isActive])
}

// ============================================
// MULTI-FACTOR AUTHENTICATION (MFA)
// ============================================

model MfaConfig {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // TOTP Secret (AES-256 encrypted)
  encryptedSecret String   @db.Text
  iv              String   // Initialization vector for decryption

  // Backup Codes (bcrypt hashed, comma-separated)
  backupCodes     String?  @db.Text

  // Status
  enabled         Boolean  @default(false)
  verifiedAt      DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// ============================================
// WEBAUTHN / PASSKEYS
// ============================================

model WebAuthnCredential {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Credential Data
  credentialId    String   @unique @db.Text  // Base64-encoded credential ID
  publicKey       String   @db.Text          // Base64-encoded public key
  counter         Int      @default(0)       // Signature counter for replay protection

  // Device Info
  deviceName      String?                    // User-provided name (e.g., "MacBook Pro")
  deviceType      String?                    // platform, cross-platform
  aaguid          String?                    // Authenticator AAGUID

  // Transports (how the authenticator communicates)
  transports      String?                    // JSON array: ["internal", "usb", "nfc", "ble"]

  // Usage
  lastUsedAt      DateTime?
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([credentialId])
}

// ============================================
// LOGIN EVENTS & SUSPICIOUS ACTIVITY
// ============================================

model LoginEvent {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Event Type
  eventType       LoginEventType @default(LOGIN_SUCCESS)

  // Device Info
  deviceType      String?  // desktop, mobile, tablet
  browser         String?
  browserVersion  String?
  os              String?
  osVersion       String?

  // Location Info
  ipAddress       String?
  city            String?
  country         String?
  countryCode     String?

  // Auth Method Used
  authMethod      AuthMethod @default(PASSWORD)

  // Suspicious Activity Detection
  isSuspicious    Boolean  @default(false)
  suspiciousReasons String? @db.Text  // JSON array of reasons

  // Related Session
  sessionId       String?

  // Additional metadata (coordinates for impossible travel detection)
  metadata        Json?

  createdAt       DateTime @default(now())

  @@index([userId, createdAt])
  @@index([ipAddress, createdAt])
  @@index([isSuspicious, createdAt])
}

enum LoginEventType {
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGIN_BLOCKED
  MFA_REQUIRED
  MFA_SUCCESS
  MFA_FAILED
  PASSKEY_SUCCESS
  PASSKEY_FAILED
  BACKUP_CODE_USED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  SUSPICIOUS_LOGIN
}

enum AuthMethod {
  PASSKEY
  PASSWORD
  OAUTH_GOOGLE
  OAUTH_GITHUB
  SAML
  OIDC
  API_KEY
}

model SecurityAuditLog {
  id             String   @id @default(cuid())
  organizationId String?
  userId         String?
  user           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Event
  event          SecurityAuditEventType
  description    String   @db.Text

  // Context
  ipAddress      String?
  userAgent      String?
  city           String?
  country        String?

  // Target (what was affected)
  targetType     String?  // user, organization, api_key, session, etc.
  targetId       String?

  // Metadata (additional context)
  metadata       Json?

  // Risk Level
  riskLevel      RiskLevel @default(LOW)

  createdAt      DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([userId, createdAt])
  @@index([event, createdAt])
  @@index([riskLevel, createdAt])
}

enum SecurityAuditEventType {
  // Authentication
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGIN_BLOCKED
  LOGOUT
  SESSION_CREATED
  SESSION_REVOKED
  SESSION_EXPIRED

  // Password
  PASSWORD_CHANGED
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED

  // MFA
  MFA_ENABLED
  MFA_DISABLED
  MFA_CHALLENGE_SUCCESS
  MFA_CHALLENGE_FAILED
  MFA_BACKUP_CODES_GENERATED
  MFA_BACKUP_CODE_USED

  // Passkeys / WebAuthn
  PASSKEY_REGISTERED
  PASSKEY_REMOVED
  PASSKEY_LOGIN_SUCCESS
  PASSKEY_LOGIN_FAILED

  // SSO
  SSO_LOGIN
  SSO_CONFIGURED
  SSO_UPDATED
  SSO_DISABLED
  SSO_TEST_SUCCESS
  SSO_TEST_FAILED

  // API Keys
  API_KEY_CREATED
  API_KEY_USED
  API_KEY_REVOKED
  API_KEY_EXPIRED
  API_KEY_ROTATED
  API_KEY_ROTATION_COMPLETED

  // Account
  ACCOUNT_CREATED
  ACCOUNT_UPDATED
  ACCOUNT_DELETED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  EMAIL_CHANGED
  EMAIL_VERIFIED

  // Organization
  ORG_MEMBER_ADDED
  ORG_MEMBER_REMOVED
  ORG_MEMBER_ROLE_CHANGED
  ORG_SETTINGS_CHANGED
  ORG_BILLING_UPDATED

  // Permissions
  PERMISSION_GRANTED
  PERMISSION_REVOKED
  ROLE_CHANGED

  // Security
  SUSPICIOUS_ACTIVITY
  BRUTE_FORCE_DETECTED
  UNUSUAL_LOCATION
  MULTIPLE_FAILED_LOGINS
  RATE_LIMIT_EXCEEDED

  // Honey Tokens
  HONEY_TOKEN_TRIGGERED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================
// HONEY TOKENS (Attacker Detection)
// ============================================

// Fake credentials/data planted to detect unauthorized access
model HoneyToken {
  id              String   @id @default(cuid())

  // Token Type
  tokenType       HoneyTokenType @default(API_KEY)
  name            String         // Descriptive name (e.g., "Fake AWS Key", "Legacy API Key")
  description     String?        @db.Text

  // Token Value
  tokenValue      String   @unique @db.Text // The fake credential/value
  tokenHash       String?        // Optional hash for quick lookup

  // Detection Config
  alertEmail      String?        // Email to notify on trigger
  alertWebhookUrl String?        // Webhook URL to call on trigger

  // Context (where the token appears to belong)
  contextPath     String?        // e.g., ".env.backup", "config/legacy.json"
  contextType     String?        // "environment", "config", "document", "api"

  // Statistics
  triggerCount    Int      @default(0)
  lastTriggeredAt DateTime?
  lastTriggeredIp String?
  lastTriggeredUa String?

  // Status
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  triggers        HoneyTokenTrigger[]

  @@index([tokenValue])
  @@index([tokenHash])
  @@index([tokenType, isActive])
}

// Records each time a honey token is accessed/used
model HoneyTokenTrigger {
  id              String   @id @default(cuid())
  honeyTokenId    String
  honeyToken      HoneyToken @relation(fields: [honeyTokenId], references: [id], onDelete: Cascade)

  // Request Context
  ipAddress       String?
  userAgent       String?  @db.Text
  requestPath     String?
  requestMethod   String?
  requestHeaders  Json?    // Sanitized headers for analysis

  // Geolocation
  city            String?
  country         String?
  countryCode     String?

  // Analysis
  severity        RiskLevel @default(HIGH)
  notes           String?   @db.Text

  createdAt       DateTime  @default(now())

  @@index([honeyTokenId, createdAt])
  @@index([ipAddress, createdAt])
}

enum HoneyTokenType {
  API_KEY           // Fake API key (caelex_fake_...)
  DATABASE_URL      // Fake database connection string
  AWS_CREDENTIAL    // Fake AWS access key/secret
  OAUTH_SECRET      // Fake OAuth client secret
  ENCRYPTION_KEY    // Fake encryption key
  WEBHOOK_SECRET    // Fake webhook signing secret
  JWT_SECRET        // Fake JWT signing key
  SSH_KEY           // Fake SSH private key
  ADMIN_PASSWORD    // Fake admin credentials
  CUSTOM            // Custom token type
}

// ============================================
// PUBLIC API & WEBHOOKS
// ============================================

model ApiKey {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Key Info
  name           String
  keyHash        String   @unique  // SHA-256 hash of the key
  keyPrefix      String   // First 8 chars for identification (caelex_...)

  // Permissions
  scopes         String[] // ['read:compliance', 'write:reports', 'read:spacecraft', ...]

  // Rate Limiting
  rateLimit      Int      @default(1000) // requests per hour

  // HMAC Signing (optional - when set, requests must include X-Signature header)
  signingSecret  String?  @db.Text // Encrypted signing secret for HMAC verification
  requireSigning Boolean  @default(false) // Whether this key requires HMAC signatures

  // Status
  isActive       Boolean  @default(true)
  lastUsedAt     DateTime?
  expiresAt      DateTime?

  // Key Rotation (48h grace period)
  previousKeyHash String?  // Hash of the previous key (valid during grace period)
  rotatedAt       DateTime? // When the key was rotated
  graceEndsAt     DateTime? // When the previous key stops working

  // Metadata
  createdById    String
  createdBy      User     @relation(fields: [createdById], references: [id])
  createdAt      DateTime @default(now())
  revokedAt      DateTime?
  revokedReason  String?

  // Relations
  requests       ApiRequest[]

  @@index([keyHash])
  @@index([organizationId])
  @@index([keyPrefix])
  @@index([previousKeyHash])
}

model ApiRequest {
  id             String   @id @default(cuid())
  apiKeyId       String
  apiKey         ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  // Request Info
  method         String   // GET, POST, PUT, DELETE
  path           String
  statusCode     Int
  responseTimeMs Int

  // Client Info
  ipAddress      String?
  userAgent      String?

  // Error Info (if failed)
  errorCode      String?
  errorMessage   String?

  createdAt      DateTime @default(now())

  @@index([apiKeyId, createdAt])
  @@index([createdAt])
}

model Webhook {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Configuration
  name           String
  url            String
  secret         String   // For HMAC signature verification

  // Events to trigger
  events         String[] // ['compliance.score_changed', 'report.generated', 'incident.created', ...]

  // Headers (custom headers to send)
  headers        Json?    // { "X-Custom-Header": "value" }

  // Status
  isActive       Boolean  @default(true)

  // Stats
  successCount   Int      @default(0)
  failureCount   Int      @default(0)
  lastTriggeredAt DateTime?
  lastSuccessAt  DateTime?
  lastFailureAt  DateTime?
  lastError      String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  deliveries     WebhookDelivery[]

  @@index([organizationId])
  @@index([isActive])
}

model WebhookDelivery {
  id             String   @id @default(cuid())
  webhookId      String
  webhook        Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  // Event
  event          String
  payload        Json

  // Delivery Info
  statusCode     Int?
  responseBody   String?  @db.Text
  responseTimeMs Int?

  // Status
  status         WebhookDeliveryStatus @default(PENDING)
  attempts       Int      @default(0)
  maxAttempts    Int      @default(3)
  nextRetryAt    DateTime?

  // Error Info
  errorMessage   String?

  createdAt      DateTime @default(now())
  deliveredAt    DateTime?

  @@index([webhookId, createdAt])
  @@index([status, nextRetryAt])
}

enum WebhookDeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
}

// ─── Collaboration Features ───

model Comment {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Author
  authorId       String
  author         User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Target entity (polymorphic)
  entityType     String   // 'spacecraft', 'document', 'workflow', 'incident', 'assessment'
  entityId       String

  // Content
  content        String   @db.Text
  mentions       String[] // Array of user IDs mentioned

  // Threading
  parentId       String?
  parent         Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies        Comment[] @relation("CommentReplies")

  // Status
  isEdited       Boolean  @default(false)
  isDeleted      Boolean  @default(false) // Soft delete

  // Timestamps
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId])
  @@index([entityType, entityId])
  @@index([authorId])
  @@index([parentId])
}

model Activity {
  id             String   @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Actor
  userId         String?
  user           User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Action details
  action         String   // 'created', 'updated', 'deleted', 'commented', 'mentioned', etc.
  entityType     String   // 'spacecraft', 'document', 'workflow', etc.
  entityId       String
  entityName     String?  // Cached name for display

  // Additional context
  description    String?
  metadata       Json?    // Additional action-specific data

  // Changes (for update actions)
  changes        Json?    // { field: { old: x, new: y } }

  // Timestamp
  createdAt      DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([entityType, entityId])
  @@index([userId])
}

// ============================================
// AUDIT CENTER — COMPLIANCE EVIDENCE
// ============================================

enum RegulationType {
  EU_SPACE_ACT
  NIS2
  CYBERSECURITY
  DEBRIS
  ENVIRONMENTAL
  INSURANCE
  AUTHORIZATION
  REGISTRATION
  SUPERVISION
  NATIONAL_SPACE_LAW
}

enum EvidenceStatus {
  DRAFT
  SUBMITTED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum EvidenceType {
  DOCUMENT
  SCREENSHOT
  ATTESTATION
  CERTIFICATE
  LOG_EXTRACT
  POLICY
  PROCEDURE
  TEST_RESULT
  EXTERNAL_REPORT
  OTHER
}

model ComplianceEvidence {
  id              String            @id @default(cuid())
  organizationId  String
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       String            // userId of the creator (audit trail)

  // What this evidence proves compliance for
  regulationType  RegulationType
  requirementId   String            // e.g., "art-74", "nis2-req-1", "debris-req-5"

  // Evidence details
  title           String
  description     String?           @db.Text
  evidenceType    EvidenceType
  status          EvidenceStatus    @default(DRAFT)

  // Validity period
  validFrom       DateTime?
  validUntil      DateTime?

  // Review
  reviewedBy      String?
  reviewedAt      DateTime?
  reviewNotes     String?           @db.Text

  // Linked documents (from existing Document vault)
  documents       ComplianceEvidenceDocument[]

  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([organizationId, regulationType, requirementId, title])
  @@index([organizationId])
  @@index([organizationId, regulationType])
  @@index([regulationType, requirementId])
  @@index([status])
}

model ComplianceEvidenceDocument {
  id              String             @id @default(cuid())
  evidenceId      String
  evidence        ComplianceEvidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  documentId      String
  document        Document           @relation(fields: [documentId], references: [id], onDelete: Cascade)

  addedAt         DateTime           @default(now())

  @@unique([evidenceId, documentId])
  @@index([evidenceId])
  @@index([documentId])
}

// ═══════════════════════════════════════════════════════════════════════════════
// ASTRA AI Compliance Copilot
// ═══════════════════════════════════════════════════════════════════════════════

model AstraConversation {
  id              String         @id @default(cuid())
  userId          String
  organizationId  String
  mode            String         @default("general")  // general, assessment, document, analysis
  summary         String?        @db.Text  // Summarized older messages for context compression
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  messages        AstraMessage[]
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
  @@index([userId, organizationId])
}

model AstraMessage {
  id              String            @id @default(cuid())
  conversationId  String
  role            String            // "user" | "assistant" | "system"
  content         String            @db.Text
  toolCalls       Json?             // Tool calls made (JSON array of AstraToolCall)
  toolResults     Json?             // Tool results received (JSON array of AstraToolResult)
  sources         Json?             // Regulatory sources cited (JSON array of AstraSource)
  confidence      String?           // "HIGH" | "MEDIUM" | "LOW"
  tokensUsed      Int?              // For cost tracking
  createdAt       DateTime          @default(now())

  // Relations
  conversation    AstraConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([conversationId, createdAt])
}

// ═══════════════════════════════════════════════════════════════════════════════
// CEO ANALYTICS DASHBOARD
// Privacy-first, self-hosted analytics for space/defense customers
// ═══════════════════════════════════════════════════════════════════════════════

// Event-based tracking for all user actions
model AnalyticsEvent {
  id              String    @id @default(cuid())
  userId          String?   // null for anonymous events (pre-login)
  organizationId  String?   // null for user-level events
  sessionId       String    // Browser session identifier

  // Event classification
  eventType       String    // page_view, feature_use, api_call, signup, login, etc.
  eventCategory   String    @default("general") // navigation, engagement, conversion, error
  eventData       Json?     // Flexible payload for event-specific data

  // Context
  path            String?   // URL path
  referrer        String?   // Referrer URL
  userAgent       String?   // Browser user agent
  ipCountry       String?   // Country from IP (for geo analytics)

  // Performance
  durationMs      Int?      // For timed events (e.g., page load, feature use)

  timestamp       DateTime  @default(now())
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([organizationId])
  @@index([sessionId])
  @@index([eventType])
  @@index([eventCategory])
  @@index([timestamp])
  @@index([userId, timestamp])
  @@index([eventType, timestamp])
}

// Pre-aggregated daily metrics for fast dashboard loading
model AnalyticsDailyAggregate {
  id              String    @id @default(cuid())
  date            DateTime  @db.Date

  // Metric identification
  metricType      String    // dau, wau, mau, signups, revenue, churn, etc.
  metricValue     Float

  // Optional dimensional breakdown
  dimension       String?   // plan, country, module, etc.
  dimensionValue  String?   // e.g., "PROFESSIONAL", "DE", "cybersecurity"

  // Comparison helpers
  previousValue   Float?    // Value from previous period
  changePercent   Float?    // Percentage change

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([date, metricType, dimension, dimensionValue])
  @@index([date])
  @@index([metricType])
  @@index([date, metricType])
}

// Customer health scoring for churn prediction
model CustomerHealthScore {
  id              String       @id @default(cuid())
  organizationId  String       @unique
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Overall score (0-100)
  score           Int
  trend           String       @default("stable") // improving, stable, declining
  riskLevel       String       @default("low") // low, medium, high, critical

  // Factor breakdown (stored as JSON for flexibility)
  factors         Json         // { loginFrequency, featureBreadth, supportTickets, etc. }

  // Key metrics
  lastLoginAt     DateTime?
  loginFrequency  Float?       // logins per week
  activeFeatures  Int?         // number of features used in last 30 days
  sessionsLast30  Int?         // session count
  avgSessionMins  Float?       // average session duration

  // Calculated at
  calculatedAt    DateTime     @default(now())
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([score])
  @@index([riskLevel])
  @@index([calculatedAt])
}

// Financial entries for revenue tracking (manual + Stripe)
model FinancialEntry {
  id              String    @id @default(cuid())

  // Entry type
  type            String    // revenue, expense, investment, refund
  category        String    // subscription, one_time, consulting, hosting, payroll, etc.

  // Amount
  amount          Float     // Always positive, sign determined by type
  currency        String    @default("EUR")

  // Source & Reference
  source          String    @default("manual") // stripe, manual, bank_import
  externalId      String?   // Stripe payment ID, invoice ID, etc.

  // Organization link (for revenue entries)
  organizationId  String?

  // Details
  description     String?   @db.Text
  date            DateTime  @db.Date

  // For MRR calculations
  isRecurring     Boolean   @default(false)
  recurringPeriod String?   // monthly, yearly

  // Audit
  createdBy       String?   // User ID who created (for manual entries)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([type])
  @@index([category])
  @@index([date])
  @@index([source])
  @@index([organizationId])
  @@index([date, type])
}

// Revenue metrics snapshot (calculated periodically)
model RevenueSnapshot {
  id              String    @id @default(cuid())
  date            DateTime  @db.Date @unique

  // MRR/ARR
  mrr             Float     // Monthly Recurring Revenue
  arr             Float     // Annual Recurring Revenue
  mrrGrowth       Float?    // MoM growth rate

  // MRR Components
  newMrr          Float     @default(0)        // From new customers
  expansionMrr    Float     @default(0)        // From upgrades
  contractionMrr  Float     @default(0)        // From downgrades
  churnedMrr      Float     @default(0)        // From churns

  // Customer metrics
  totalCustomers  Int
  newCustomers    Int       @default(0)
  churnedCustomers Int      @default(0)

  // Unit economics
  arpu            Float?    // Average Revenue Per User
  ltv             Float?    // Lifetime Value

  // Cash position (manual input)
  cashBalance     Float?
  burnRate        Float?
  runwayMonths    Float?

  createdAt       DateTime  @default(now())

  @@index([date])
}

// Feature usage tracking for product analytics
model FeatureUsageDaily {
  id              String    @id @default(cuid())
  date            DateTime  @db.Date

  // Feature identification
  featureId       String    // e.g., "eu_space_act", "nis2", "document_vault"
  featureName     String    // Display name
  moduleCategory  String    // assessment, compliance, documents, etc.

  // Usage metrics
  uniqueUsers     Int       @default(0)
  totalSessions   Int       @default(0)
  totalActions    Int       @default(0)
  avgDurationSecs Float?

  // Engagement depth
  completionRate  Float?    // For workflows: % who complete

  createdAt       DateTime  @default(now())

  @@unique([date, featureId])
  @@index([date])
  @@index([featureId])
  @@index([moduleCategory])
}

// Acquisition/Marketing tracking
model AcquisitionEvent {
  id              String    @id @default(cuid())

  // User journey
  userId          String?   // Linked after signup
  anonymousId     String    // Pre-signup tracking

  // Acquisition source
  source          String    // google, direct, referral, linkedin, etc.
  medium          String?   // organic, paid, email, social
  campaign        String?   // UTM campaign
  content         String?   // UTM content
  term            String?   // UTM term (for paid search)

  // Landing
  landingPage     String?
  referrerUrl     String?

  // Conversion tracking
  eventType       String    // visit, signup, activation, conversion

  // Geo
  country         String?

  timestamp       DateTime  @default(now())

  @@index([userId])
  @@index([anonymousId])
  @@index([source])
  @@index([eventType])
  @@index([timestamp])
  @@index([source, medium, timestamp])
}

// System health metrics for infrastructure monitoring
model SystemHealthMetric {
  id              String    @id @default(cuid())
  timestamp       DateTime  @default(now())

  // Metric identification
  metricName      String    // api_latency_p50, error_rate, uptime, etc.
  service         String    @default("main") // main, api, database, etc.

  // Value
  value           Float
  unit            String?   // ms, percent, count, etc.

  // Context
  endpoint        String?   // For API metrics
  statusCode      Int?      // For HTTP metrics

  @@index([timestamp])
  @@index([metricName])
  @@index([service])
  @@index([timestamp, metricName])
}

// API endpoint performance tracking
model ApiEndpointMetrics {
  id              String    @id @default(cuid())
  date            DateTime  @db.Date

  // Endpoint identification
  method          String    // GET, POST, etc.
  path            String    // API path pattern (e.g., /api/dashboard/overview)

  // Volume
  totalCalls      Int       @default(0)
  uniqueUsers     Int       @default(0)

  // Performance (in milliseconds)
  avgLatency      Float?
  p50Latency      Float?
  p95Latency      Float?
  p99Latency      Float?

  // Errors
  errorCount      Int       @default(0)
  errorRate       Float?    // percentage

  createdAt       DateTime  @default(now())

  @@unique([date, method, path])
  @@index([date])
  @@index([path])
  @@index([errorRate])
}
